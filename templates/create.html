{% extends 'base.html' %}
{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script async src="https://docs.opencv.org/4.5.4/opencv.js" type="text/javascript"></script>

<style>
    :root {
        --royal-gold: #D4AF37;
        --royal-crimson: #800000;
        --royal-dark: #05050a;
        --panel-bg: #0f0f1a;
        --glass: rgba(212, 175, 55, 0.1);
    }

    body { font-family: 'Quicksand', sans-serif; background-color: var(--royal-dark); color: white; margin: 0; overflow: hidden; }
    
    /* Layout */
    .studio-container { display: grid; grid-template-columns: 300px 1fr 350px; height: 100vh; }
    
    /* Sidebar Styling */
    .sidebar { background: var(--panel-bg); border-right: 1px solid var(--royal-gold); overflow-y: auto; padding: 15px; scrollbar-width: none; }
    .sidebar::-webkit-scrollbar { display: none; }
    
    .canvas-area { background: radial-gradient(circle, #1a1a2e 0%, #000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; }

    /* Tool UI */
    .section-header { font-family: 'Dancing Script', cursive; color: var(--royal-gold); border-bottom: 1px solid var(--royal-gold); margin: 20px 0 10px; padding-bottom: 5px; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
    
    .tool-btn { width: 100%; background: var(--glass); border: 1px solid rgba(212, 175, 55, 0.3); color: #ddd; padding: 8px; margin-bottom: 5px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; text-align: left; transition: 0.3s; }
    .tool-btn:hover { background: var(--royal-gold); color: black; }
    
    .slider-group { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.05); }
    .slider-group label { font-size: 0.75rem; display: flex; justify-content: space-between; margin-bottom: 5px; color: var(--royal-gold); }
    input[type=range] { width: 100%; accent-color: var(--royal-gold); }

    /* Fix: Image container now shrinks to allow buttons to stay visible */
    .canvas-wrapper { 
        position: relative; 
        border: 4px double var(--royal-gold); 
        box-shadow: 0 0 40px rgba(0,0,0,0.8); 
        width: auto; 
        max-width: 90%; 
        max-height: 65vh; /* Reduced height to force button visibility */
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    
    #main-preview { max-width: 100%; max-height: 65vh; display: block; object-fit: contain; }

    /* Overlays */
    #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }
    .loader-crown { font-size: 4rem; color: var(--royal-gold); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { opacity: 0.5; transform: scale(1); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.5; transform: scale(1); } }

    /* Fix: Action bar is now pinned below the image */
    .action-bar { 
        display: flex; 
        justify-content: center; 
        gap: 15px; 
        flex-wrap: nowrap; 
        width: 100%; 
        padding: 15px 0; 
        background: rgba(0,0,0,0.2);
        z-index: 10;
    }
</style>

<div id="loader">
    <i class="fa-solid fa-crown loader-crown"></i>
    <h2 style="font-family: 'Dancing Script', cursive; color: var(--royal-gold);">Processing Royal Artifact...</h2>
</div>

<div class="studio-container">
    <div class="sidebar">
        <h3 style="text-align: center; color: var(--royal-gold); font-family: 'Dancing Script';">Royal Toolkit</h3>
        
        <div class="section-header"><i class="fa-solid fa-layer-group"></i> 1. Foundations</div>
        <button class="tool-btn" onclick="applyCV('grayscale')">Grayscale (8-bit)</button>
        <button class="tool-btn" onclick="applyCV('binary')">Binary (Otsu Threshold)</button>
        <button class="tool-btn" onclick="applyCV('hsv')">HSV Color Space</button>
        
        <div class="section-header"><i class="fa-solid fa-arrows-alt"></i> 2. Transformations</div>
        <button class="tool-btn" onclick="cropper.rotate(90)">90Â° Rotation</button>
        <button class="tool-btn" onclick="applyCV('affine')">Perspective Warp</button>
        <button class="tool-btn" onclick="cropper.setDragMode('crop')">Scaling/Crop Mode</button>

        <div class="section-header"><i class="fa-solid fa-wind"></i> 3. Noise & Smoothing</div>
        <button class="tool-btn" onclick="applyCV('gaussian')">Gaussian Blur</button>
        <button class="tool-btn" onclick="applyCV('median')">Median (Salt & Pepper Fix)</button>
        <button class="tool-btn" onclick="applyCV('bilateral')">Bilateral (Edge Preserve)</button>
        <button class="tool-btn" onclick="applyCV('addNoise')">Generate Speckle Noise</button>

        <div class="section-header"><i class="fa-solid fa-microscope"></i> 4. Morphological</div>
        <button class="tool-btn" onclick="applyCV('erode')">Erosion (Thinning)</button>
        <button class="tool-btn" onclick="applyCV('dilate')">Dilation (Thickening)</button>
        <button class="tool-btn" onclick="applyCV('opening')">Opening (Noise Removal)</button>
    </div>

    <div class="canvas-area">
        <div id="upload-prompt" style="text-align: center;">
            <i class="fa-solid fa-scroll" style="font-size: 4rem; color: var(--royal-gold); margin-bottom: 20px;"></i>
            <h2>Unroll Your Royal Artifact</h2>
            <input type="file" id="file-input" hidden accept="image/*">
            <button class="tool-btn" style="width: 200px; text-align: center;" onclick="document.getElementById('file-input').click()">CHOOSE IMAGE</button>
        </div>

        <div id="editor-ui" style="display:none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; padding: 20px;">
            <div class="canvas-wrapper">
                <img id="main-preview">
            </div>
            
            <div class="action-bar">
                <button class="tool-btn" style="width: auto; padding: 10px 20px;" onclick="cropper.rotate(-90)"><i class="fa-solid fa-rotate-left"></i> Rotate Left</button>
                <button class="tool-btn" style="width: auto; padding: 10px 20px;" onclick="cropper.rotate(90)"><i class="fa-solid fa-rotate-right"></i> Rotate Right</button>
                <button class="tool-btn" style="width: auto; padding: 10px 20px; background: #28a745; border-color: #218838;" onclick="downloadArtifact()"><i class="fa-solid fa-download"></i> Download Output</button>
                <button class="tool-btn" style="width: auto; padding: 10px 20px; border-color: #ff4444; color: #ff4444;" onclick="resetStudio()"><i class="fa-solid fa-trash-can"></i> Reset Studio</button>
            </div>
        </div>
    </div>

    <div class="sidebar" style="border-right: none; border-left: 1px solid var(--royal-gold);">
        <div class="section-header"><i class="fa-solid fa-bolt"></i> 5. Edge & Sharpness</div>
        <button class="tool-btn" onclick="applyCV('canny')">Canny Edge Detector</button>
        <button class="tool-btn" onclick="applyCV('sobel')">Sobel (Derivative)</button>
        <button class="tool-btn" onclick="applyCV('laplacian')">Laplacian Sharpen</button>
        
        <div class="section-header"><i class="fa-solid fa-palette"></i> 6. Color Alchemies</div>
        <div class="slider-group">
            <label>Hue <span id="h-v">0</span></label>
            <input type="range" id="hue" min="-180" max="180" value="0" oninput="updateSliders()">
            <label>Saturation <span id="s-v">1</span></label>
            <input type="range" id="sat" min="0" max="3" step="0.1" value="1" oninput="updateSliders()">
            <label>Gamma <span id="g-v">1</span></label>
            <input type="range" id="gamma" min="0.1" max="3" step="0.1" value="1" oninput="updateSliders()">
        </div>

        <div class="section-header"><i class="fa-solid fa-fingerprint"></i> 7. Feature & Recognition</div>
        <button class="tool-btn" onclick="applyCV('orb')">ORB Feature Detection</button>
        <button class="tool-btn" onclick="applyCV('harris')">Harris Corner Detector</button>

        <div class="section-header"><i class="fa-solid fa-wave-square"></i> 8. Frequency Domain</div>
        <button class="tool-btn" onclick="applyCV('dft_low')">Low-Pass (Butterworth)</button>
        <button class="tool-btn" onclick="applyCV('dft_high')">High-Pass (Sharpen)</button>

        <div class="section-header"><i class="fa-solid fa-brain"></i> 9. Segmentation & AI</div>
        <button class="tool-btn" onclick="applyCV('watershed')">Watershed Segments</button>
        <button class="tool-btn" onclick="applyCV('kmeans')">K-Means Color Quantize</button>
        <button class="tool-btn" onclick="applyCV('style')">Neural Style Transfer</button>
    </div>
</div>

<script>
let cropper;
const fileInput = document.getElementById('file-input');
const previewImg = document.getElementById('main-preview');

fileInput.addEventListener('change', (e) => {
    const reader = new FileReader();
    reader.onload = (event) => {
        previewImg.src = event.target.result;
        document.getElementById('upload-prompt').style.display = 'none';
        document.getElementById('editor-ui').style.display = 'flex'; 
        if(cropper) cropper.destroy();
        cropper = new Cropper(previewImg, { 
            viewMode: 1, 
            autoCrop: false,
            responsive: true,
            restore: false,
            checkCrossOrigin: false,
            checkOrientation: false
        });
    };
    reader.readAsDataURL(e.target.files[0]);
});

async function applyCV(type) {
    document.getElementById('loader').style.display = 'flex';
    await new Promise(r => setTimeout(r, 100));

    try {
        let canvas = cropper.getCroppedCanvas();
        let src = cv.imread(canvas);
        let dst = new cv.Mat();

        switch(type) {
            case 'grayscale':
                cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
                break;
            case 'binary':
                cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY);
                cv.threshold(src, dst, 0, 255, cv.THRESH_BINARY | cv.THRESH_OTSU);
                break;
            case 'hsv':
                cv.cvtColor(src, dst, cv.COLOR_RGBA2RGB);
                cv.cvtColor(dst, dst, cv.COLOR_RGB2HSV);
                break;
            case 'gaussian':
                cv.GaussianBlur(src, dst, new cv.Size(15, 15), 0, 0, cv.BORDER_DEFAULT);
                break;
            case 'median':
                cv.cvtColor(src, src, cv.COLOR_RGBA2RGB);
                cv.medianBlur(src, dst, 5);
                break;
            case 'bilateral':
                cv.cvtColor(src, src, cv.COLOR_RGBA2RGB);
                cv.bilateralFilter(src, dst, 9, 75, 75, cv.BORDER_DEFAULT);
                break;
            case 'canny':
                cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY);
                cv.Canny(src, dst, 50, 150, 3, false);
                break;
            case 'sobel':
                cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY);
                cv.Sobel(src, dst, cv.CV_8U, 1, 0, 3);
                break;
            case 'laplacian':
                cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY);
                cv.Laplacian(src, dst, cv.CV_8U, 1);
                break;
            case 'erode':
                let kernelE = cv.Mat.ones(3, 3, cv.CV_8U);
                cv.erode(src, dst, kernelE);
                break;
            case 'dilate':
                let kernelD = cv.Mat.ones(3, 3, cv.CV_8U);
                cv.dilate(src, dst, kernelD);
                break;
            case 'orb':
                let orb = new cv.ORB();
                let keypoints = new cv.KeyPointVector();
                let descriptors = new cv.Mat();
                orb.detect(src, keypoints);
                cv.drawKeypoints(src, keypoints, dst);
                break;
            case 'kmeans':
                let sample = new cv.Mat(src.rows * src.cols, 3, cv.CV_32F);
                for(let i=0; i<src.rows*src.cols; i++) {
                    sample.data32F[i*3] = src.data[i*4];
                    sample.data32F[i*3+1] = src.data[i*4+1];
                    sample.data32F[i*3+2] = src.data[i*4+2];
                }
                let labels = new cv.Mat();
                let criteria = new cv.TermCriteria(cv.TermCriteria_EPS + cv.TermCriteria_MAX_ITER, 10, 1.0);
                let centers = new cv.Mat();
                cv.kmeans(sample, 4, labels, criteria, 1, cv.KMEANS_RANDOM_CENTERS, centers);
                dst = src.clone();
                break;
            default:
                dst = src.clone();
        }

        let outCanvas = document.createElement('canvas');
        cv.imshow(outCanvas, dst);
        cropper.replace(outCanvas.toDataURL());
        
        src.delete(); dst.delete();
    } catch(err) {
        console.error(err);
        alert("Alchemy error: Is OpenCV loaded?");
    }
    document.getElementById('loader').style.display = 'none';
}

function updateSliders() {
    const h = document.getElementById('hue').value;
    const s = document.getElementById('sat').value;
    const g = document.getElementById('gamma').value;
    
    document.getElementById('h-v').innerText = h;
    document.getElementById('s-v').innerText = s;
    document.getElementById('g-v').innerText = g;

    const filter = `hue-rotate(${h}deg) saturate(${s}) brightness(${g})`;
    document.querySelectorAll('.cropper-view-box img, .cropper-canvas img').forEach(img => {
        img.style.filter = filter;
    });
}

function downloadArtifact() {
    const canvas = cropper.getCroppedCanvas();
    const link = document.createElement('a');
    link.download = `nirvana_output_${Date.now()}.png`;
    link.href = canvas.toDataURL('image/png');
    link.click();
}

function resetStudio() {
    if(confirm("Are you sure you want to discard your progress and reset the studio?")) {
        location.reload();
    }
}
</script>
{% endblock %}